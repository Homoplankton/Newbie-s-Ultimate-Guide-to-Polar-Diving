<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>极地潜水指南 — 一个月速通极地潜水员</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg: #000000;
      --bg-panel: #000000;
      --text: #d0d4db;
      --h1: #D9B24A;
      --h2: #CBB07A;
      --h3: #B49F78;
      --h4: #A49372;
      --accent: #E4BD4A;
      --hero-title: #F2CC63;
      --border: #1a1a1a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Noto Sans SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      line-height: 1.9;
      color: var(--text);
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
    }
    html.lang-en body {
      font-family: "IBM Plex Sans", "Helvetica Neue", sans-serif;
    }
    .layout {
      display: flex;
      max-width: 1200px;
      margin: 0 auto;
      min-height: 100vh;
    }
    .toc-wrap {
      flex: 0 0 260px;
      padding: 2.5rem 1rem 2rem 0;
      position: sticky;
      top: 0;
      max-height: 100vh;
      overflow-y: auto;
      background: var(--bg);
    }
    .toc-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 0.75rem;
      padding-left: 0.5rem;
    }
    .lang-switcher {
      padding: 0.5rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: center;
      gap: 0.5rem;
    }
    .lang-btn {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.8rem;
      cursor: pointer;
      border-radius: 4px;
      font-family: "IBM Plex Sans", sans-serif;
      font-size: 0.85rem;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .lang-btn:hover {
      background: rgba(245, 197, 24, 0.12);
      border-color: var(--accent);
      color: var(--accent);
    }
    .lang-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
      font-weight: 600;
    }
    .toc {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.88rem;
    }
    .toc li { margin: 0; }
    .toc a {
      display: block;
      padding: 0.35rem 0.5rem;
      color: #b0b0b0;
      text-decoration: none;
      border-radius: 4px;
      border-left: 3px solid transparent;
      transition: color 0.15s, background 0.15s, border-color 0.15s;
    }
    .toc a:hover {
      background: rgba(245, 197, 24, 0.12);
      color: var(--accent);
      border-left-color: var(--accent);
    }
    .toc a.active {
      background: rgba(245, 197, 24, 0.14);
      color: var(--accent);
      border-left-color: var(--accent);
      font-weight: 500;
    }
    .toc .toc-h1 { padding-left: 0.5rem; font-weight: 600; color: var(--h1); }
    .toc .toc-h2 { padding-left: 1rem; color: var(--h2); }
    .toc .toc-h3 { padding-left: 1.5rem; font-size: 0.82rem; color: var(--h3); }
    .toc .toc-h4 { padding-left: 2rem; font-size: 0.78rem; color: var(--h4); }
    .content-wrap {
      flex: 1;
      min-width: 0;
      padding: 2rem 2rem 3rem;
      background: #000;
    }
    .content {
      max-width: 760px;
      margin: 0 auto;
    }
    .front-matter {
      border: 1px solid var(--border);
      background: linear-gradient(
        180deg,
        color-mix(in srgb, var(--accent) 10%, var(--bg-panel)),
        color-mix(in srgb, var(--accent) 3%, var(--bg-panel))
      );
      border-radius: 8px;
      padding: 0.75rem 0.85rem 0.65rem;
      margin: 0 0 1.2rem;
      position: sticky;
      top: 0.5rem;
      z-index: 50;
      backdrop-filter: blur(4px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.22);
    }
    .front-matter-title {
      margin: 0;
      color: var(--hero-title);
      font-size: 1.35rem;
      line-height: 1.3;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    .front-matter-subtitle {
      margin: 0.35rem 0 0;
      color: var(--text);
      opacity: 0.9;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .front-matter-meta {
      margin: 0.55rem 0 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .front-matter-chip {
      display: inline-flex;
      align-items: center;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 35%, transparent);
      color: var(--text);
      border-radius: 999px;
      padding: 0.15rem 0.5rem;
      font-size: 0.68rem;
      letter-spacing: 0.01em;
    }
    .content-wrap h1 {
      font-size: 1.7rem;
      font-weight: 700;
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      color: var(--h1);
      border-bottom: 2px solid var(--h1);
      scroll-margin-top: 1rem;
      letter-spacing: 0.02em;
    }
    .content-wrap h1:first-child { margin-top: 0; }
    .content-wrap h2 {
      font-size: 1.24rem;
      font-weight: 600;
      margin: 0;
      color: var(--h2);
      scroll-margin-top: 1rem;
      letter-spacing: 0.02em;
      pointer-events: none;
    }
    .content-wrap h3 {
      font-size: 1.08rem;
      font-weight: 600;
      margin: 0;
      color: var(--h3);
      scroll-margin-top: 1rem;
      letter-spacing: 0.02em;
      pointer-events: none;
    }
    .collapsible-section { margin: 1.5rem 0 0.5rem; }
    .collapsible-section.h1-section { margin: 2rem 0 1rem; }
    .collapsible-section.h2-section { margin: 1.75rem 0 0.75rem; }
    .collapsible-section.h4-section { margin: 1rem 0 0.25rem; }
    .collapsible-trigger {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      padding: 0.35rem 0;
      user-select: none;
      border-radius: 4px;
    }
    .collapsible-trigger:hover { text-shadow: 0 0 10px rgba(255, 255, 255, 0.6), 0 0 25px rgba(255, 255, 255, 0.3); }
    .collapsible-icon {
      flex-shrink: 0;
      font-size: 0.65rem;
      color: var(--h3);
      transition: transform 0.2s ease;
    }
    .collapsible-section.collapsed .collapsible-icon { transform: rotate(-90deg); }
    .collapsible-body {
      overflow: hidden;
      max-height: none;
    }
    .collapsible-section.collapsed .collapsible-body {
      max-height: 0 !important;
      margin-top: 0;
      padding-top: 0;
    }
    .content-wrap h4 {
      font-size: 1.02rem;
      font-weight: 600;
      margin: 1.25rem 0 0.5rem;
      color: var(--h4);
      scroll-margin-top: 1rem;
      letter-spacing: 0.02em;
    }
    .content-wrap p { margin: 0 0 1.2rem; color: var(--text); }
    .content-wrap ul, .content-wrap ol {
      margin: 0 0 1.2rem;
      padding-left: 1.35rem;
      margin-left: 0.05rem;
      color: var(--text);
      border-left: 1px solid color-mix(in srgb, var(--accent) 16%, transparent);
    }
    .content-wrap li { margin: 0.45rem 0; }
    .content-wrap li::marker { color: var(--accent); }
    .content-wrap strong { font-weight: 700; color: #ffffff; }
    .content-wrap u { text-decoration: none; font-weight: 700; color: #ffffff; }
    .content-wrap a { color: var(--accent); text-decoration: none; }
    .content-wrap a:hover { text-decoration: underline; }
    .content-wrap hr { border: none; border-top: 1px solid var(--border); margin: 2rem 0; }
    .content-wrap br { display: block; content: ""; margin-top: 0.5rem; }
    .content-wrap code { background: rgba(245, 197, 24, 0.15); color: var(--accent); padding: 0.15em 0.4em; border-radius: 4px; font-size: 0.92em; }
    .content-wrap img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 1.5rem auto 0.3rem;
      border-radius: 0;
    }
    .content-wrap img.portrait-img {
      max-width: 50%;
    }
    .content-wrap figure {
      margin: 1.5rem auto;
      padding: 0;
      text-align: center;
    }
    .content-wrap figure img {
      margin: 0 auto 0.3rem;
    }
    .content-wrap figcaption {
      text-align: center;
      font-size: 0.8rem;
      color: #a8adb5;
      font-style: normal;
      margin-top: 0.45rem;
      line-height: 1.45;
      letter-spacing: 0.01em;
    }
    .content-wrap blockquote {
      margin: 1rem 0;
      padding: 0.8rem 1.2rem;
      background: rgba(255, 255, 255, 0.10);
      border-radius: 6px;
      color: var(--text);
    }
    .content-wrap blockquote p { margin: 0.3rem 0; }
    .content-wrap .admonition {
      border-left: 3px solid var(--accent);
      background: rgba(245, 197, 24, 0.08);
    }
    .content-wrap .admonition::before {
      content: attr(data-label);
      display: block;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.3rem;
      font-size: 0.85rem;
    }
    .content-wrap mark {
      background: rgba(255, 191, 0, 0.2);
      color: #fff;
      padding: 0.1em 0.25em;
      border-radius: 3px;
    }
    .loading, .error {
      padding: 2rem;
      text-align: center;
      color: #888;
    }
    .error { color: var(--h2); }
    .load-hint {
      font-size: 0.9rem;
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(255, 179, 0, 0.12);
      border: 1px solid var(--h4);
      border-radius: 8px;
      color: var(--h4);
    }
    .load-hint code { background: rgba(0,0,0,0.3); color: var(--accent); }
    .site-logo {
      position: fixed;
      top: 0.8rem;
      left: 0;
      width: 260px;
      text-align: center;
      font-family: "Share Tech Mono", monospace;
      font-size: 1.1rem;
      letter-spacing: 0.25em;
      color: var(--h1);
      z-index: 1000;
      text-decoration: none;
      pointer-events: auto;
    }
    .site-logo:hover { opacity: 0.8; }
    .top-right-stack {
      position: fixed;
      top: 0.8rem;
      right: 2rem;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .site-logo-right {
      position: static;
      font-family: "Share Tech Mono", monospace;
      font-size: 1.1rem;
      letter-spacing: 0.25em;
      color: var(--h1);
      text-decoration: none;
      pointer-events: auto;
    }
    .site-logo-right:hover { opacity: 0.8; }
    .contact-right {
      position: static;
      margin-top: 0.5rem;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0.45rem;
    }
    .contact-link {
      width: 2.35rem;
      height: 2.35rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      text-decoration: none;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: color-mix(in srgb, var(--bg-panel) 85%, transparent);
      transition: color 0.2s, border-color 0.2s, transform 0.2s, background 0.2s;
    }
    .contact-link:hover {
      color: var(--accent);
      border-color: var(--accent);
      background: color-mix(in srgb, var(--accent) 10%, transparent);
      transform: translateY(-1px);
    }
    .contact-symbol {
      width: 1.2rem;
      height: 1.2rem;
      display: block;
      color: currentColor;
      flex-shrink: 0;
    }
    @media (max-width: 900px) {
      .layout { flex-direction: column; }
      .toc-wrap {
        position: static;
        max-height: none;
        padding: 0;
        border-right: none;
        border-bottom: none;
        flex: none;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .toc-title, .toc { display: none; }
      .lang-switcher {
        padding: 0.6rem 0 0.8rem;
        margin-bottom: 0;
      }
      .content-wrap { padding: 1.5rem; border-left: none; }
      .site-logo {
        position: static;
        display: block;
        width: 100%;
        text-align: center;
        padding: 1rem 0 0;
        font-size: 1rem;
        letter-spacing: 0.2em;
      }
      .top-right-stack { display: none; }
      .contact-right { display: none; }
      .content-wrap h1 { margin: 0.6rem 0 0.3rem; font-size: 1.3rem; padding-bottom: 0.3rem; }
      .collapsible-section.h1-section { margin: 0.6rem 0 0.2rem; }
      .content-wrap img.portrait-img {
        max-width: 75%;
      }
    }
    .scroll-glow {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100dvh;
      padding-bottom: env(safe-area-inset-bottom);
      pointer-events: none;
      z-index: 9999;
      box-shadow: inset 0 0 40px color-mix(in srgb, var(--hero-title) 60%, transparent);
      opacity: 0;
      transition: opacity 0.4s ease;
      will-change: opacity;
      transform: translateZ(0);
    }
    @supports not (height: 100dvh) {
      .scroll-glow { height: 100vh; }
    }
    .scroll-glow.active {
      opacity: 1;
    }
    .side-decor {
      position: fixed;
      top: 6rem;
      bottom: 0.45rem;
      width: 188px;
      display: none;
      pointer-events: none;
      z-index: 30;
      overflow: hidden;
    }
    .side-decor.left { left: 0.5rem; }
    .side-decor.right { right: 0.5rem; }
    .side-decor img {
      position: absolute;
      width: auto;
      height: var(--h);
      max-width: 95%;
      top: var(--y);
      left: var(--x);
      object-fit: contain;
      object-position: center;
      border-radius: 0;
      background: transparent;
      opacity: 0.98;
      transform: rotate(var(--r));
      transform-origin: center center;
      mix-blend-mode: screen;
      filter: brightness(1.02) contrast(1.12) saturate(0.9);
    }
    .side-decor.left .c1 { --y: 1%; --x: 6%; --h: 18vh; --r: -6deg; }
    .side-decor.left .c2 { --y: 22%; --x: 35%; --h: 15vh; --r: 5deg; }
    .side-decor.left .c3 { --y: 40%; --x: 8%; --h: 19vh; --r: -3deg; }
    .side-decor.left .c4 { --y: 63%; --x: 39%; --h: 14vh; --r: 4deg; }
    .side-decor.left .c5 { --y: 80%; --x: 12%; --h: 16vh; --r: -5deg; }
    .side-decor.right .c1 { --y: 2%; --x: 28%; --h: 17vh; --r: 6deg; }
    .side-decor.right .c2 { --y: 21%; --x: 4%; --h: 15vh; --r: -4deg; }
    .side-decor.right .c3 { --y: 41%; --x: 30%; --h: 18vh; --r: 3deg; }
    .side-decor.right .c4 { --y: 63%; --x: 2%; --h: 14vh; --r: -5deg; }
    .side-decor.right .c5 { --y: 80%; --x: 24%; --h: 16vh; --r: 4deg; }
    @media (min-width: 1700px) {
      .side-decor {
        width: 220px;
      }
    }
    @media (min-width: 1360px) {
      .side-decor { display: flex; }
    }
  </style>
</head>
<body>
  <div class="scroll-glow"></div>
  <aside class="side-decor left" aria-label="Left decorations">
    <img class="c1" src="SideColumnDecorations/optimized/DSC_0883-Edit.jpg" alt="" loading="lazy" decoding="async">
    <img class="c2" src="SideColumnDecorations/optimized/DSC_1912.jpg" alt="" loading="lazy" decoding="async">
    <img class="c3" src="SideColumnDecorations/optimized/DSC_2132.jpg" alt="" loading="lazy" decoding="async">
    <img class="c4" src="SideColumnDecorations/optimized/DSC_21581.jpg" alt="" loading="lazy" decoding="async">
    <img class="c5" src="SideColumnDecorations/optimized/DSC_2846.jpg" alt="" loading="lazy" decoding="async">
  </aside>
  <aside class="side-decor right" aria-label="Right decorations">
    <img class="c1" src="SideColumnDecorations/optimized/DSC_33761.jpg" alt="" loading="lazy" decoding="async">
    <img class="c2" src="SideColumnDecorations/optimized/DSC_3519.jpg" alt="" loading="lazy" decoding="async">
    <img class="c3" src="SideColumnDecorations/optimized/DSC_3767.jpg" alt="" loading="lazy" decoding="async">
    <img class="c4" src="SideColumnDecorations/optimized/DSC_4560.jpg" alt="" loading="lazy" decoding="async">
    <img class="c5" src="SideColumnDecorations/optimized/_Y3A0361.jpg" alt="" loading="lazy" decoding="async">
  </aside>
  <div class="top-right-stack">
    <a class="site-logo-right" href="#">HOMOPLANKTON</a>
    <aside class="contact-right" aria-label="Contact">
      <a class="contact-link" href="mailto:Jialingcai@homoplankton.com" aria-label="Email" title="Jialingcai@homoplankton.com">
        <svg class="contact-symbol" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <rect x="3.5" y="5.5" width="17" height="13" rx="2"></rect>
          <path d="M4.5 7l7.5 6 7.5-6"></path>
        </svg>
      </a>
      <a class="contact-link" href="https://instagram.com/homoplankton" target="_blank" rel="noopener noreferrer" aria-label="Instagram" title="@homoplankton">
        <svg class="contact-symbol" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <rect x="4" y="4" width="16" height="16" rx="4"></rect>
          <circle cx="12" cy="12" r="3.5"></circle>
          <circle cx="17.3" cy="6.7" r="1"></circle>
        </svg>
      </a>
      <a class="contact-link" href="https://homoplankton.substack.com" target="_blank" rel="noopener noreferrer" aria-label="Substack" title="homoplankton">
        <svg class="contact-symbol" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <rect x="4" y="3" width="16" height="2.5" rx="1"></rect>
          <rect x="4" y="7" width="16" height="2.5" rx="1"></rect>
          <path d="M6 11h12v10l-6-3-6 3V11z"></path>
        </svg>
      </a>
      <a class="contact-link" href="https://www.homoplankton.com" target="_blank" rel="noopener noreferrer" aria-label="Website" title="www.homoplankton.com">
        <svg class="contact-symbol" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M3 12h18M12 3a13.5 13.5 0 0 1 0 18M12 3a13.5 13.5 0 0 0 0 18"></path>
        </svg>
      </a>
    </aside>
  </div>
  <div class="layout">
    <nav class="toc-wrap" aria-label="目录">
      <a class="site-logo" href="#">HOMOPLANKTON</a>
      <div class="lang-switcher">
        <button class="lang-btn" data-lang="zh">中文</button>
        <button class="lang-btn" data-lang="en">English</button>
      </div>
      <div class="toc-title" id="toc-title">目录</div>
      <ul class="toc" id="toc"></ul>
    </nav>
    <main class="content-wrap">
      <div id="content" class="content"></div>
      <div id="loading" class="loading">正在加载内容…</div>
      <div id="error" class="error" style="display:none;"></div>
    </main>
  </div>

<!-- Chinese content now loaded dynamically from .md file, same as English -->
<!-- To update content, edit the markdown files directly -->


  <script>
    (function() {
      const contentEl = document.getElementById('content');
      const tocEl = document.getElementById('toc');
      const tocTitleEl = document.getElementById('toc-title');
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');

      const mdFiles = {
        zh: 'polar-diving-guide-zh.md',
        en: 'Ultimate-Guide-to-Polar-Diving.md'
      };

      const pageTitles = {
        zh: '极地潜水指南 — 一个月速通极地潜水员',
        en: 'Polar Diving Guide — Ultimate Guide in One Month'
      };

      const tocTitles = {
        zh: '目录',
        en: 'Contents'
      };

      let currentLang = localStorage.getItem('polarDivingLang') || 'zh';
      let mdFilename = mdFiles[currentLang];

      function showError(msg) {
        loadingEl.style.display = 'none';
        contentEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.innerHTML = msg;
      }

      function slugify(text) {
        return text
          .trim()
          .replace(/\s+/g, '-')
          .replace(/[^\w\u4e00-\u9fff\-]/g, '')
          .replace(/-+/g, '-')
          .replace(/^-|-$/g, '') || 'section';
      }

      function ensureUniqueId(el, slugs) {
        let id = slugify(el.textContent);
        if (slugs[id] === undefined) slugs[id] = 0;
        slugs[id]++;
        el.id = slugs[id] === 1 ? id : id + '-' + slugs[id];
      }

      function buildToc(container) {
        const headings = container.querySelectorAll('h1, h2, h3, h4');
        const slugs = {};
        headings.forEach(function(h) { ensureUniqueId(h, slugs); });

        tocEl.innerHTML = '';
        headings.forEach(function(h) {
          const a = document.createElement('a');
          a.href = '#' + h.id;
          a.textContent = h.textContent;
          a.classList.add('toc-' + h.tagName.toLowerCase());
          a.addEventListener('click', function(e) {
            e.preventDefault();
            var target = document.getElementById(h.id);
            if (!target) return;
            // Expand all collapsed parent sections so the target becomes visible
            var el = target.closest('.collapsible-section');
            // First, if the heading itself is a trigger, expand its own section
            var ownSection = target.closest('.collapsible-trigger');
            if (ownSection) {
              var sec = ownSection.closest('.collapsible-section');
              if (sec && sec.classList.contains('collapsed')) {
                sec.classList.remove('collapsed');
                sec.querySelector('.collapsible-trigger').setAttribute('aria-expanded', 'true');
              }
            }
            // Then expand all ancestor collapsed sections
            var parent = target.closest('.collapsible-body');
            while (parent) {
              var parentSection = parent.closest('.collapsible-section');
              if (parentSection && parentSection.classList.contains('collapsed')) {
                parentSection.classList.remove('collapsed');
                parentSection.querySelector('.collapsible-trigger').setAttribute('aria-expanded', 'true');
              }
              var grandparent = parentSection ? parentSection.parentElement : null;
              parent = grandparent ? grandparent.closest('.collapsible-body') : null;
            }
            // Scroll to the target after expanding
            setTimeout(function() {
              target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 50);
          });
          const li = document.createElement('li');
          li.appendChild(a);
          tocEl.appendChild(li);
        });
      }

      function setActiveToc() {
        const ids = Array.from(document.querySelectorAll('.content-wrap [id]')).map(function(el) { return el.id; });
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        let current = '';
        for (let i = ids.length - 1; i >= 0; i--) {
          const el = document.getElementById(ids[i]);
          if (el && el.getBoundingClientRect().top <= 120) {
            current = ids[i];
            break;
          }
        }
        tocEl.querySelectorAll('a').forEach(function(a) {
          a.classList.toggle('active', a.getAttribute('href') === '#' + current);
        });
      }

      function parseFrontMatter(md) {
        var match = md.match(/^---\s*\n([\s\S]*?)\n---\s*\n?/);
        var meta = {};
        var content = md;
        if (match) {
          content = md.slice(match[0].length);
          match[1].split('\n').forEach(function(line) {
            var kv = line.match(/^\s*([A-Za-z0-9_-]+)\s*:\s*(.*?)\s*$/);
            if (!kv) return;
            var key = kv[1].toLowerCase();
            var val = kv[2].replace(/^["']|["']$/g, '');
            meta[key] = val;
          });
        }
        return { meta: meta, content: content };
      }

      function escapeHtml(text) {
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function buildFrontMatterHtml(meta) {
        if (!meta || (!meta.title && !meta.subtitle && !meta.date && !meta.author)) return '';
        var chips = [];
        if (meta.date) chips.push('<span class="front-matter-chip">' + escapeHtml(meta.date) + '</span>');
        if (meta.author) chips.push('<span class="front-matter-chip">' + escapeHtml(meta.author) + '</span>');
        return [
          '<section class="front-matter">',
          meta.title ? '<div class="front-matter-title">' + escapeHtml(meta.title) + '</div>' : '',
          meta.subtitle ? '<p class="front-matter-subtitle">' + escapeHtml(meta.subtitle) + '</p>' : '',
          chips.length ? '<div class="front-matter-meta">' + chips.join('') + '</div>' : '',
          '</section>'
        ].join('');
      }

      function prepareContent(md) {
        var parsed = parseFrontMatter(md);
        var out = parsed.content;
        // Remove the "Judging Criteria" section (heading and its list only)
        out = out.replace(/\n# Judging Criteria\s*\n(?:- \[ \].*\n)+/m, '');
        return { frontMatter: parsed.meta, body: out.trim() };
      }

      function render(md) {
        if (!md || typeof marked === 'undefined') {
          showError('无法解析内容。若直接打开本地文件，请用本地服务器运行（见下方说明）。');
          return;
        }
        var prepared = prepareContent(md);
        marked.setOptions({ gfm: true, breaks: true });
        marked.use({
          extensions: [{
            name: 'highlight',
            level: 'inline',
            start: function(src) { var m = src.match(/==/); return m ? m.index : undefined; },
            tokenizer: function(src) {
              var match = src.match(/^==([^=]+=?[^=]*)==/);
              if (match) return { type: 'highlight', raw: match[0], text: this.lexer.inlineTokens(match[1]) };
            },
            renderer: function(token) { return '<mark>' + this.parser.parseInline(token.text) + '</mark>'; }
          }]
        });
        contentEl.innerHTML = buildFrontMatterHtml(prepared.frontMatter) + marked.parse(prepared.body);
        contentEl.querySelectorAll('blockquote').forEach(function(bq) {
          var first = bq.querySelector('p');
          if (first) {
            var match = first.textContent.match(/^\[!(.+?)\]!?\s*/);
            if (match) {
              bq.classList.add('admonition');
              bq.setAttribute('data-label', match[1]);
              first.textContent = first.textContent.replace(/^\[!.+?\]!?\s*/, '');
              if (!first.textContent.trim()) first.remove();
            }
          }
        });
        // Image post-processing: prefer optimized assets, set loading strategy, and detect portrait images
        Array.from(contentEl.querySelectorAll('img')).forEach(function(img, index) {
          var originalSrc = img.getAttribute('src') || '';
          var optimizedSrc = originalSrc.startsWith('Images/')
            ? originalSrc.replace(/^Images\//, 'Images/optimized/')
            : '';

          // Prioritize top-of-page images and defer the rest.
          img.setAttribute('loading', index < 2 ? 'eager' : 'lazy');
          img.setAttribute('fetchpriority', index < 2 ? 'high' : 'low');
          img.setAttribute('decoding', 'async');

          // Keep original as default; only swap after optimized image is verified loadable.
          if (optimizedSrc) {
            var probe = new Image();
            probe.decoding = 'async';
            probe.onload = function() {
              img.setAttribute('src', optimizedSrc);
            };
            probe.onerror = function() {
              // Keep original source if optimized asset is unavailable or incompatible.
            };
            probe.src = optimizedSrc;
          }

          img.addEventListener('load', function() {
            if (this.naturalHeight > this.naturalWidth) {
              this.classList.add('portrait-img');
            }
          });
        });
        contentEl.style.display = 'block';
        loadingEl.style.display = 'none';

        buildToc(contentEl);
        makeCollapsible(contentEl);

        window.addEventListener('scroll', setActiveToc);
        setActiveToc();
      }

      function makeCollapsible(container) {
        // Process from deepest level (h4) up to h1 so nesting works correctly
        var levels = ['h4', 'h3', 'h2', 'h1'];
        var stopTags = { h1: ['H1'], h2: ['H1', 'H2'], h3: ['H1', 'H2', 'H3'], h4: ['H1', 'H2', 'H3', 'H4'] };

        // Helper: get the heading level of a collapsible-section wrapper (e.g. 'H3' for h3-section)
        function getSectionLevel(el) {
          if (!el.classList.contains('collapsible-section')) return null;
          if (el.classList.contains('h1-section')) return 'H1';
          if (el.classList.contains('h2-section')) return 'H2';
          if (el.classList.contains('h3-section')) return 'H3';
          if (el.classList.contains('h4-section')) return 'H4';
          return null;
        }

        levels.forEach(function(level) {
          var headings = Array.from(container.querySelectorAll(level)).filter(function(h) {
            return !h.closest('.collapsible-section');
          });
          var stops = stopTags[level];
          for (var i = headings.length - 1; i >= 0; i--) {
            var heading = headings[i];
            var parent = heading.parentNode;
            if (!parent) continue;
            var hText = heading.textContent.trim();
            // Determine if this section should start collapsed (Appendix/附录 h1 sections only)
            var isAppendix = level === 'h1' && (/^Appendix\s/i.test(hText) || /^附录/.test(hText));
            var section = document.createElement('div');
            section.className = 'collapsible-section ' + level + '-section' + (isAppendix ? ' collapsed' : '');
            var trigger = document.createElement('div');
            trigger.className = 'collapsible-trigger';
            trigger.setAttribute('role', 'button');
            trigger.setAttribute('tabindex', '0');
            trigger.setAttribute('aria-expanded', isAppendix ? 'false' : 'true');
            trigger.setAttribute('title', '点击展开/收起');
            var icon = document.createElement('span');
            icon.className = 'collapsible-icon';
            icon.setAttribute('aria-hidden', 'true');
            icon.textContent = '\u25BC';
            trigger.appendChild(icon);
            var body = document.createElement('div');
            body.className = 'collapsible-body';
            section.appendChild(trigger);
            section.appendChild(body);
            parent.insertBefore(section, heading);
            trigger.appendChild(heading);
            var next = section.nextElementSibling;
            while (next) {
              var tag = next.tagName.toUpperCase();
              // Stop at a same-or-higher level raw heading
              if (stops.indexOf(tag) !== -1) break;
              // Stop at a same-or-higher level collapsible section wrapper
              var secLevel = getSectionLevel(next);
              if (secLevel && stops.indexOf(secLevel) !== -1) break;
              // Otherwise pull this element (including nested collapsible sections) into the body
              body.appendChild(next);
              next = section.nextElementSibling;
            }
            (function(sec, trig) {
              function toggleSection(e) {
                sec.classList.toggle('collapsed');
                trig.setAttribute('aria-expanded', sec.classList.contains('collapsed') ? 'false' : 'true');
              }
              trig.addEventListener('click', toggleSection);
              trig.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSection(e); }
              });
            })(section, trigger);
          }
        });
      }

      function updateLanguageUI() {
        document.documentElement.className = 'lang-' + currentLang;
        document.title = pageTitles[currentLang];
        tocTitleEl.textContent = tocTitles[currentLang];
        document.querySelectorAll('.lang-btn').forEach(function(btn) {
          if (btn.dataset.lang === currentLang) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      function switchLanguage(lang) {
        currentLang = lang;
        mdFilename = mdFiles[lang];
        localStorage.setItem('polarDivingLang', lang);
        updateLanguageUI();
        loadContent();
      }

      function tryLoad() {
        var hint = document.createElement('div');
        hint.className = 'load-hint';
        hint.innerHTML = '请用本地服务器打开：在<strong>本文件夹</strong>打开终端，执行 <code>npx serve .</code> 或 <code>python3 -m http.server 8000</code>，然后访问显示的地址（如 http://localhost:3000）。不要直接双击打开 index.html。';
        showError('未能加载文章文件（Failed to fetch）。' + hint.outerHTML);
      }

      function loadContent() {
        contentEl.style.display = 'none';
        loadingEl.style.display = 'block';
        errorEl.style.display = 'none';

        var encodedFilename = encodeURIComponent(mdFilename);
        fetch(encodedFilename)
          .then(function(r) {
            if (!r.ok) throw new Error(r.status + ' ' + mdFilename);
            return r.text();
          })
          .then(render)
          .catch(function(err) {
            fetch('./' + encodedFilename)
              .then(function(r) {
                if (!r.ok) throw new Error(r.status);
                return r.text();
              })
              .then(render)
              .catch(tryLoad);
          });
      }

      // Initialize
      updateLanguageUI();
      loadContent();

      // Add language switcher event listeners
      document.querySelectorAll('.lang-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          switchLanguage(btn.dataset.lang);
        });
      });

      // Scroll glow effect
      var glowEl = document.querySelector('.scroll-glow');
      var scrollTimer;
      window.addEventListener('scroll', function() {
        glowEl.classList.add('active');
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(function() {
          glowEl.classList.remove('active');
        }, 600);
      });
    })();
  </script>
</body>
</html>
