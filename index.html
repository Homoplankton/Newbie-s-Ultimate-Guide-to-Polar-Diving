<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>极地潜水指南 — 一个月速通极地潜水员</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg: #000000;
      --bg-panel: #0a0a0a;
      --text: #c8c8c8;
      --h1: #c9a86c;
      --h2: #c9a0a0;
      --h3: #8fa88f;
      --h4: #c4b896;
      --accent: #c9a86c;
      --border: #1a1a1a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Noto Sans SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      line-height: 1.85;
      color: var(--text);
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
    }
    html.lang-en body {
      font-family: "IBM Plex Sans", "Helvetica Neue", sans-serif;
    }
    .layout {
      display: flex;
      max-width: 1200px;
      margin: 0 auto;
      min-height: 100vh;
    }
    .toc-wrap {
      flex: 0 0 260px;
      padding: 2.5rem 1rem 2rem 0;
      position: sticky;
      top: 0;
      max-height: 100vh;
      overflow-y: auto;
      background: var(--bg);
    }
    .toc-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 0.75rem;
      padding-left: 0.5rem;
    }
    .lang-switcher {
      padding: 0.5rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: center;
      gap: 0.5rem;
    }
    .lang-btn {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.8rem;
      cursor: pointer;
      border-radius: 4px;
      font-family: "IBM Plex Sans", sans-serif;
      font-size: 0.85rem;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .lang-btn:hover {
      background: rgba(201, 168, 108, 0.12);
      border-color: var(--accent);
      color: var(--accent);
    }
    .lang-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
      font-weight: 600;
    }
    .toc {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.88rem;
    }
    .toc li { margin: 0; }
    .toc a {
      display: block;
      padding: 0.35rem 0.5rem;
      color: #b0b0b0;
      text-decoration: none;
      border-radius: 4px;
      border-left: 3px solid transparent;
      transition: color 0.15s, background 0.15s, border-color 0.15s;
    }
    .toc a:hover {
      background: rgba(201, 168, 108, 0.12);
      color: var(--accent);
      border-left-color: var(--accent);
    }
    .toc a.active {
      background: rgba(201, 168, 108, 0.14);
      color: var(--accent);
      border-left-color: var(--accent);
      font-weight: 500;
    }
    .toc .toc-h1 { padding-left: 0.5rem; font-weight: 600; color: var(--h1); }
    .toc .toc-h2 { padding-left: 1rem; color: var(--h2); }
    .toc .toc-h3 { padding-left: 1.5rem; font-size: 0.82rem; color: var(--h3); }
    .toc .toc-h4 { padding-left: 2rem; font-size: 0.78rem; color: var(--h4); }
    .content-wrap {
      flex: 1;
      min-width: 0;
      padding: 2rem 2rem 3rem;
      background: var(--bg-panel);
    }
    .content-wrap h1 {
      font-size: 1.7rem;
      font-weight: 700;
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      color: var(--h1);
      border-bottom: 2px solid var(--h1);
      scroll-margin-top: 1rem;
      letter-spacing: 0.02em;
    }
    .content-wrap h1:first-child { margin-top: 0; }
    .content-wrap h2 {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 0;
      color: var(--h2);
      scroll-margin-top: 1rem;
      letter-spacing: 0.02em;
      pointer-events: none;
    }
    .content-wrap h3 {
      font-size: 1.12rem;
      font-weight: 600;
      margin: 0;
      color: var(--h3);
      scroll-margin-top: 1rem;
      letter-spacing: 0.02em;
      pointer-events: none;
    }
    .collapsible-section { margin: 1.5rem 0 0.5rem; }
    .collapsible-section.h1-section { margin: 2rem 0 1rem; }
    .collapsible-section.h2-section { margin: 1.75rem 0 0.75rem; }
    .collapsible-section.h4-section { margin: 1rem 0 0.25rem; }
    .collapsible-trigger {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      padding: 0.35rem 0;
      user-select: none;
      border-radius: 4px;
      border-left: 3px solid transparent;
    }
    .collapsible-trigger:hover { opacity: 0.9; background: rgba(143, 168, 143, 0.08); border-left-color: var(--h3); }
    .collapsible-icon {
      flex-shrink: 0;
      font-size: 0.65rem;
      color: var(--h3);
      transition: transform 0.2s ease;
    }
    .collapsible-section.collapsed .collapsible-icon { transform: rotate(-90deg); }
    .collapsible-body {
      overflow: hidden;
      max-height: none;
    }
    .collapsible-section.collapsed .collapsible-body {
      max-height: 0 !important;
      margin-top: 0;
      padding-top: 0;
    }
    .content-wrap h4 {
      font-size: 1.02rem;
      font-weight: 600;
      margin: 1.25rem 0 0.5rem;
      color: var(--h4);
      scroll-margin-top: 1rem;
      letter-spacing: 0.02em;
    }
    .content-wrap p { margin: 0 0 1rem; color: var(--text); }
    .content-wrap ul, .content-wrap ol { margin: 0 0 1rem; padding-left: 1.5rem; color: var(--text); }
    .content-wrap li { margin: 0.3rem 0; }
    .content-wrap li::marker { color: var(--accent); }
    .content-wrap strong { font-weight: 700; color: #ffffff; }
    .content-wrap a { color: var(--accent); text-decoration: none; }
    .content-wrap a:hover { text-decoration: underline; }
    .content-wrap hr { border: none; border-top: 1px solid var(--border); margin: 2rem 0; }
    .content-wrap br { display: block; content: ""; margin-top: 0.5rem; }
    .content-wrap code { background: rgba(201, 168, 108, 0.15); color: var(--accent); padding: 0.15em 0.4em; border-radius: 4px; font-size: 0.92em; }
    .loading, .error {
      padding: 2rem;
      text-align: center;
      color: #888;
    }
    .error { color: var(--h2); }
    .load-hint {
      font-size: 0.9rem;
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(255, 179, 0, 0.12);
      border: 1px solid var(--h4);
      border-radius: 8px;
      color: var(--h4);
    }
    .load-hint code { background: rgba(0,0,0,0.3); color: var(--accent); }
    .site-logo {
      position: fixed;
      top: 0.8rem;
      left: 0;
      width: 260px;
      text-align: center;
      font-family: "Share Tech Mono", monospace;
      font-size: 1.1rem;
      letter-spacing: 0.25em;
      color: var(--h1);
      z-index: 1000;
      text-decoration: none;
      pointer-events: auto;
    }
    .site-logo:hover { opacity: 0.8; }
    .site-logo-right {
      position: fixed;
      top: 0.8rem;
      right: 2rem;
      font-family: "Share Tech Mono", monospace;
      font-size: 1.1rem;
      letter-spacing: 0.25em;
      color: var(--h1);
      z-index: 1000;
      text-decoration: none;
      pointer-events: auto;
    }
    .site-logo-right:hover { opacity: 0.8; }
    @media (max-width: 900px) {
      .layout { flex-direction: column; }
      .toc-wrap {
        position: static;
        max-height: none;
        padding: 0;
        border-right: none;
        border-bottom: none;
        flex: none;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .toc-title, .toc { display: none; }
      .lang-switcher {
        padding: 0.6rem 0 0.8rem;
        margin-bottom: 0;
      }
      .content-wrap { padding: 1.5rem; border-left: none; }
      .site-logo {
        position: static;
        display: block;
        width: 100%;
        text-align: center;
        padding: 1rem 0 0;
        font-size: 1rem;
        letter-spacing: 0.2em;
      }
      .site-logo-right { display: none; }
      .content-wrap h1 { margin: 0.6rem 0 0.3rem; font-size: 1.3rem; padding-bottom: 0.3rem; }
      .collapsible-section.h1-section { margin: 0.6rem 0 0.2rem; }
    }
    .scroll-glow {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 9999;
      box-shadow: inset 0 0 40px rgba(201, 168, 108, 0.6);
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .scroll-glow.active {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="scroll-glow"></div>
  <a class="site-logo-right" href="#">HOMOPLANKTON</a>
  <div class="layout">
    <nav class="toc-wrap" aria-label="目录">
      <a class="site-logo" href="#">HOMOPLANKTON</a>
      <div class="lang-switcher">
        <button class="lang-btn" data-lang="zh">中文</button>
        <button class="lang-btn" data-lang="en">English</button>
      </div>
      <div class="toc-title" id="toc-title">目录</div>
      <ul class="toc" id="toc"></ul>
    </nav>
    <main class="content-wrap">
      <div id="content" class="content"></div>
      <div id="loading" class="loading">正在加载内容…</div>
      <div id="error" class="error" style="display:none;"></div>
    </main>
  </div>

<!-- Chinese content now loaded dynamically from .md file, same as English -->
<!-- To update content, edit the markdown files directly -->


  <script>
    (function() {
      const contentEl = document.getElementById('content');
      const tocEl = document.getElementById('toc');
      const tocTitleEl = document.getElementById('toc-title');
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');

      const mdFiles = {
        zh: 'polar-diving-guide-zh.md',
        en: 'Ultimate-Guide-to-Polar-Diving.md'
      };

      const pageTitles = {
        zh: '极地潜水指南 — 一个月速通极地潜水员',
        en: 'Polar Diving Guide — Ultimate Guide in One Month'
      };

      const tocTitles = {
        zh: '目录',
        en: 'Contents'
      };

      let currentLang = localStorage.getItem('polarDivingLang') || 'zh';
      let mdFilename = mdFiles[currentLang];

      function showError(msg) {
        loadingEl.style.display = 'none';
        contentEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.innerHTML = msg;
      }

      function slugify(text) {
        return text
          .trim()
          .replace(/\s+/g, '-')
          .replace(/[^\w\u4e00-\u9fff\-]/g, '')
          .replace(/-+/g, '-')
          .replace(/^-|-$/g, '') || 'section';
      }

      function ensureUniqueId(el, slugs) {
        let id = slugify(el.textContent);
        if (slugs[id] === undefined) slugs[id] = 0;
        slugs[id]++;
        el.id = slugs[id] === 1 ? id : id + '-' + slugs[id];
      }

      function buildToc(container) {
        const headings = container.querySelectorAll('h1, h2, h3, h4');
        const slugs = {};
        headings.forEach(function(h) { ensureUniqueId(h, slugs); });

        tocEl.innerHTML = '';
        headings.forEach(function(h) {
          const a = document.createElement('a');
          a.href = '#' + h.id;
          a.textContent = h.textContent;
          a.classList.add('toc-' + h.tagName.toLowerCase());
          a.addEventListener('click', function(e) {
            e.preventDefault();
            var target = document.getElementById(h.id);
            if (!target) return;
            // Expand all collapsed parent sections so the target becomes visible
            var el = target.closest('.collapsible-section');
            // First, if the heading itself is a trigger, expand its own section
            var ownSection = target.closest('.collapsible-trigger');
            if (ownSection) {
              var sec = ownSection.closest('.collapsible-section');
              if (sec && sec.classList.contains('collapsed')) {
                sec.classList.remove('collapsed');
                sec.querySelector('.collapsible-trigger').setAttribute('aria-expanded', 'true');
              }
            }
            // Then expand all ancestor collapsed sections
            var parent = target.closest('.collapsible-body');
            while (parent) {
              var parentSection = parent.closest('.collapsible-section');
              if (parentSection && parentSection.classList.contains('collapsed')) {
                parentSection.classList.remove('collapsed');
                parentSection.querySelector('.collapsible-trigger').setAttribute('aria-expanded', 'true');
              }
              var grandparent = parentSection ? parentSection.parentElement : null;
              parent = grandparent ? grandparent.closest('.collapsible-body') : null;
            }
            // Scroll to the target after expanding
            setTimeout(function() {
              target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 50);
          });
          const li = document.createElement('li');
          li.appendChild(a);
          tocEl.appendChild(li);
        });
      }

      function setActiveToc() {
        const ids = Array.from(document.querySelectorAll('.content-wrap [id]')).map(function(el) { return el.id; });
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        let current = '';
        for (let i = ids.length - 1; i >= 0; i--) {
          const el = document.getElementById(ids[i]);
          if (el && el.getBoundingClientRect().top <= 120) {
            current = ids[i];
            break;
          }
        }
        tocEl.querySelectorAll('a').forEach(function(a) {
          a.classList.toggle('active', a.getAttribute('href') === '#' + current);
        });
      }

      function prepareContent(md) {
        // Remove YAML frontmatter (--- ... ---)
        var out = md.replace(/^---\s*[\s\S]*?^---\s*\n?/m, '');
        // Remove the "Judging Criteria" section (heading and its list only)
        out = out.replace(/\n# Judging Criteria\s*\n(?:- \[ \].*\n)+/m, '');
        return out.trim();
      }

      function render(md) {
        if (!md || typeof marked === 'undefined') {
          showError('无法解析内容。若直接打开本地文件，请用本地服务器运行（见下方说明）。');
          return;
        }
        md = prepareContent(md);
        marked.setOptions({ gfm: true, breaks: true });
        contentEl.innerHTML = marked.parse(md);
        contentEl.style.display = 'block';
        loadingEl.style.display = 'none';

        buildToc(contentEl);
        makeCollapsible(contentEl);

        window.addEventListener('scroll', setActiveToc);
        setActiveToc();
      }

      function makeCollapsible(container) {
        // Process from deepest level (h4) up to h1 so nesting works correctly
        var levels = ['h4', 'h3', 'h2', 'h1'];
        var stopTags = { h1: ['H1'], h2: ['H1', 'H2'], h3: ['H1', 'H2', 'H3'], h4: ['H1', 'H2', 'H3', 'H4'] };

        // Helper: get the heading level of a collapsible-section wrapper (e.g. 'H3' for h3-section)
        function getSectionLevel(el) {
          if (!el.classList.contains('collapsible-section')) return null;
          if (el.classList.contains('h1-section')) return 'H1';
          if (el.classList.contains('h2-section')) return 'H2';
          if (el.classList.contains('h3-section')) return 'H3';
          if (el.classList.contains('h4-section')) return 'H4';
          return null;
        }

        levels.forEach(function(level) {
          var headings = Array.from(container.querySelectorAll(level)).filter(function(h) {
            return !h.closest('.collapsible-section');
          });
          var stops = stopTags[level];
          for (var i = headings.length - 1; i >= 0; i--) {
            var heading = headings[i];
            var parent = heading.parentNode;
            if (!parent) continue;
            // Skip intro/closing sections — keep them always expanded
            var hText = heading.textContent.trim();
            if (hText === '引言' || hText === '结语' || hText === 'Introduction' || hText === 'Closing Thoughts') continue;
            var section = document.createElement('div');
            section.className = 'collapsible-section ' + level + '-section collapsed';
            var trigger = document.createElement('div');
            trigger.className = 'collapsible-trigger';
            trigger.setAttribute('role', 'button');
            trigger.setAttribute('tabindex', '0');
            trigger.setAttribute('aria-expanded', 'false');
            trigger.setAttribute('title', '点击展开/收起');
            var icon = document.createElement('span');
            icon.className = 'collapsible-icon';
            icon.setAttribute('aria-hidden', 'true');
            icon.textContent = '\u25BC';
            trigger.appendChild(icon);
            var body = document.createElement('div');
            body.className = 'collapsible-body';
            section.appendChild(trigger);
            section.appendChild(body);
            parent.insertBefore(section, heading);
            trigger.appendChild(heading);
            var next = section.nextElementSibling;
            while (next) {
              var tag = next.tagName.toUpperCase();
              // Stop at a same-or-higher level raw heading
              if (stops.indexOf(tag) !== -1) break;
              // Stop at a same-or-higher level collapsible section wrapper
              var secLevel = getSectionLevel(next);
              if (secLevel && stops.indexOf(secLevel) !== -1) break;
              // Otherwise pull this element (including nested collapsible sections) into the body
              body.appendChild(next);
              next = section.nextElementSibling;
            }
            (function(sec, trig) {
              function toggleSection(e) {
                sec.classList.toggle('collapsed');
                trig.setAttribute('aria-expanded', sec.classList.contains('collapsed') ? 'false' : 'true');
              }
              trig.addEventListener('click', toggleSection);
              trig.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSection(e); }
              });
            })(section, trigger);
          }
        });
      }

      function updateLanguageUI() {
        document.documentElement.className = 'lang-' + currentLang;
        document.title = pageTitles[currentLang];
        tocTitleEl.textContent = tocTitles[currentLang];
        document.querySelectorAll('.lang-btn').forEach(function(btn) {
          if (btn.dataset.lang === currentLang) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      function switchLanguage(lang) {
        currentLang = lang;
        mdFilename = mdFiles[lang];
        localStorage.setItem('polarDivingLang', lang);
        updateLanguageUI();
        loadContent();
      }

      function tryLoad() {
        var hint = document.createElement('div');
        hint.className = 'load-hint';
        hint.innerHTML = '请用本地服务器打开：在<strong>本文件夹</strong>打开终端，执行 <code>npx serve .</code> 或 <code>python3 -m http.server 8000</code>，然后访问显示的地址（如 http://localhost:3000）。不要直接双击打开 index.html。';
        showError('未能加载文章文件（Failed to fetch）。' + hint.outerHTML);
      }

      function loadContent() {
        contentEl.style.display = 'none';
        loadingEl.style.display = 'block';
        errorEl.style.display = 'none';

        var encodedFilename = encodeURIComponent(mdFilename);
        fetch(encodedFilename)
          .then(function(r) {
            if (!r.ok) throw new Error(r.status + ' ' + mdFilename);
            return r.text();
          })
          .then(render)
          .catch(function(err) {
            fetch('./' + encodedFilename)
              .then(function(r) {
                if (!r.ok) throw new Error(r.status);
                return r.text();
              })
              .then(render)
              .catch(tryLoad);
          });
      }

      // Initialize
      updateLanguageUI();
      loadContent();

      // Add language switcher event listeners
      document.querySelectorAll('.lang-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          switchLanguage(btn.dataset.lang);
        });
      });

      // Scroll glow effect
      var glowEl = document.querySelector('.scroll-glow');
      var scrollTimer;
      window.addEventListener('scroll', function() {
        glowEl.classList.add('active');
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(function() {
          glowEl.classList.remove('active');
        }, 600);
      });
    })();
  </script>
</body>
</html>
