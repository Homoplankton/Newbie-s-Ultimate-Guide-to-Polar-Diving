<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>极地潜水指南 — 一个月速通极地潜水员</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg: #000000;
      --bg-panel: #0a0a0a;
      --text: #c8c8c8;
      --h1: #c9a86c;
      --h2: #c9a0a0;
      --h3: #8fa88f;
      --h4: #c4b896;
      --accent: #c9a86c;
      --border: #1a1a1a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", sans-serif;
      line-height: 1.85;
      color: var(--text);
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
    }
    .layout {
      display: flex;
      max-width: 1200px;
      margin: 0 auto;
      min-height: 100vh;
    }
    .toc-wrap {
      flex: 0 0 260px;
      padding: 1.5rem 1rem 2rem 0;
      position: sticky;
      top: 0;
      max-height: 100vh;
      overflow-y: auto;
      background: var(--bg);
      border-right: 1px solid var(--border);
    }
    .toc-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 0.75rem;
      padding-left: 0.5rem;
    }
    .lang-switcher {
      padding: 0.5rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    .lang-btn {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.8rem;
      margin: 0 0.25rem;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    .lang-btn:hover {
      background: rgba(201, 168, 108, 0.12);
      border-color: var(--accent);
      color: var(--accent);
    }
    .lang-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
      font-weight: 600;
    }
    .toc {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.88rem;
    }
    .toc li { margin: 0; }
    .toc a {
      display: block;
      padding: 0.35rem 0.5rem;
      color: #b0b0b0;
      text-decoration: none;
      border-radius: 4px;
      border-left: 3px solid transparent;
      transition: color 0.15s, background 0.15s, border-color 0.15s;
    }
    .toc a:hover {
      background: rgba(201, 168, 108, 0.12);
      color: var(--accent);
      border-left-color: var(--accent);
    }
    .toc a.active {
      background: rgba(201, 168, 108, 0.14);
      color: var(--accent);
      border-left-color: var(--accent);
      font-weight: 500;
    }
    .toc .toc-h1 { padding-left: 0.5rem; font-weight: 600; color: var(--h1); }
    .toc .toc-h2 { padding-left: 1rem; color: var(--h2); }
    .toc .toc-h3 { padding-left: 1.5rem; font-size: 0.82rem; color: var(--h3); }
    .toc .toc-h4 { padding-left: 2rem; font-size: 0.78rem; color: var(--h4); }
    .content-wrap {
      flex: 1;
      min-width: 0;
      padding: 2rem 2rem 3rem;
      background: var(--bg-panel);
      border-left: 1px solid var(--border);
    }
    .content-wrap h1 {
      font-size: 1.7rem;
      font-weight: 700;
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      color: var(--h1);
      border-bottom: 2px solid var(--h1);
      scroll-margin-top: 1rem;
      letter-spacing: 0.02em;
    }
    .content-wrap h1:first-child { margin-top: 0; }
    .content-wrap h2 {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 0;
      color: var(--h2);
      scroll-margin-top: 1rem;
      letter-spacing: 0.02em;
      pointer-events: none;
    }
    .content-wrap h3 {
      font-size: 1.12rem;
      font-weight: 600;
      margin: 0;
      color: var(--h3);
      scroll-margin-top: 1rem;
      letter-spacing: 0.02em;
      pointer-events: none;
    }
    .collapsible-section { margin: 1.5rem 0 0.5rem; }
    .collapsible-section.h2-section { margin: 1.75rem 0 0.75rem; }
    .collapsible-trigger {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      padding: 0.35rem 0;
      user-select: none;
      border-radius: 4px;
      border-left: 3px solid transparent;
    }
    .collapsible-trigger:hover { opacity: 0.9; background: rgba(143, 168, 143, 0.08); border-left-color: var(--h3); }
    .collapsible-icon {
      flex-shrink: 0;
      font-size: 0.65rem;
      color: var(--h3);
      transition: transform 0.2s ease;
    }
    .collapsible-section.collapsed .collapsible-icon { transform: rotate(-90deg); }
    .collapsible-body {
      overflow: hidden;
      max-height: 5000px;
      transition: max-height 0.25s ease;
    }
    .collapsible-section.collapsed .collapsible-body {
      max-height: 0 !important;
      margin-top: 0;
      padding-top: 0;
    }
    .content-wrap h4 {
      font-size: 1.02rem;
      font-weight: 600;
      margin: 1.25rem 0 0.5rem;
      color: var(--h4);
      scroll-margin-top: 1rem;
      letter-spacing: 0.02em;
    }
    .content-wrap p { margin: 0 0 1rem; color: var(--text); }
    .content-wrap ul, .content-wrap ol { margin: 0 0 1rem; padding-left: 1.5rem; color: var(--text); }
    .content-wrap li { margin: 0.3rem 0; }
    .content-wrap li::marker { color: var(--accent); }
    .content-wrap strong { font-weight: 600; color: #ddd; }
    .content-wrap a { color: var(--accent); text-decoration: none; }
    .content-wrap a:hover { text-decoration: underline; }
    .content-wrap hr { border: none; border-top: 1px solid var(--border); margin: 2rem 0; }
    .content-wrap br { display: block; content: ""; margin-top: 0.5rem; }
    .content-wrap code { background: rgba(201, 168, 108, 0.15); color: var(--accent); padding: 0.15em 0.4em; border-radius: 4px; font-size: 0.92em; }
    .loading, .error {
      padding: 2rem;
      text-align: center;
      color: #888;
    }
    .error { color: var(--h2); }
    .load-hint {
      font-size: 0.9rem;
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(255, 179, 0, 0.12);
      border: 1px solid var(--h4);
      border-radius: 8px;
      color: var(--h4);
    }
    .load-hint code { background: rgba(0,0,0,0.3); color: var(--accent); }
    @media (max-width: 900px) {
      .layout { flex-direction: column; }
      .toc-wrap {
        position: static;
        max-height: none;
        padding: 1rem 1.5rem;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      .content-wrap { padding: 1.5rem; border-left: none; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <nav class="toc-wrap" aria-label="目录">
      <div class="lang-switcher">
        <button class="lang-btn" data-lang="zh">中文</button>
        <button class="lang-btn" data-lang="en">English</button>
      </div>
      <div class="toc-title" id="toc-title">目录</div>
      <ul class="toc" id="toc"></ul>
    </nav>
    <main class="content-wrap">
      <div id="content" class="content"></div>
      <div id="loading" class="loading">正在加载内容…</div>
      <div id="error" class="error" style="display:none;"></div>
    </main>
  </div>


  <script>
    (function() {
      const contentEl = document.getElementById('content');
      const tocEl = document.getElementById('toc');
      const tocTitleEl = document.getElementById('toc-title');
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');

      const mdFiles = {
        zh: '一个月速通极地潜水员，需要准备些什么（装备篇和技能篇）.md',
        en: 'Ultimate-Guide-to-Polar-Diving.md'
      };

      const pageTitles = {
        zh: '极地潜水指南 — 一个月速通极地潜水员',
        en: 'Polar Diving Guide — Ultimate Guide in One Month'
      };

      const tocTitles = {
        zh: '目录',
        en: 'Contents'
      };

      let currentLang = localStorage.getItem('polarDivingLang') || 'zh';
      let mdFilename = mdFiles[currentLang];

      function showError(msg) {
        loadingEl.style.display = 'none';
        contentEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.innerHTML = msg;
      }

      function slugify(text) {
        return text
          .trim()
          .replace(/\s+/g, '-')
          .replace(/[^\w\u4e00-\u9fff\-]/g, '')
          .replace(/-+/g, '-')
          .replace(/^-|-$/g, '') || 'section';
      }

      function ensureUniqueId(el, slugs) {
        let id = slugify(el.textContent);
        if (slugs[id] === undefined) slugs[id] = 0;
        slugs[id]++;
        el.id = slugs[id] === 1 ? id : id + '-' + slugs[id];
      }

      function buildToc(container) {
        const headings = container.querySelectorAll('h1, h2, h3, h4');
        const slugs = {};
        headings.forEach(function(h) { ensureUniqueId(h, slugs); });

        tocEl.innerHTML = '';
        headings.forEach(function(h) {
          const a = document.createElement('a');
          a.href = '#' + h.id;
          a.textContent = h.textContent;
          a.classList.add('toc-' + h.tagName.toLowerCase());
          const li = document.createElement('li');
          li.appendChild(a);
          tocEl.appendChild(li);
        });
      }

      function setActiveToc() {
        const ids = Array.from(document.querySelectorAll('.content-wrap [id]')).map(function(el) { return el.id; });
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        let current = '';
        for (let i = ids.length - 1; i >= 0; i--) {
          const el = document.getElementById(ids[i]);
          if (el && el.getBoundingClientRect().top <= 120) {
            current = ids[i];
            break;
          }
        }
        tocEl.querySelectorAll('a').forEach(function(a) {
          a.classList.toggle('active', a.getAttribute('href') === '#' + current);
        });
      }

      function prepareContent(md) {
        // Remove YAML frontmatter (--- ... ---)
        var out = md.replace(/^---\s*[\s\S]*?^---\s*\n?/m, '');
        // Remove the "Judging Criteria" section (heading and its list only)
        out = out.replace(/\n# Judging Criteria\s*\n(?:- \[ \].*\n)+/m, '');
        return out.trim();
      }

      function render(md) {
        if (!md || typeof marked === 'undefined') {
          showError('无法解析内容。若直接打开本地文件，请用本地服务器运行（见下方说明）。');
          return;
        }
        md = prepareContent(md);
        marked.setOptions({ gfm: true, breaks: true });
        contentEl.innerHTML = marked.parse(md);
        contentEl.style.display = 'block';
        loadingEl.style.display = 'none';

        buildToc(contentEl);
        makeH2Collapsible(contentEl);
        makeH3Collapsible(contentEl);

        window.addEventListener('scroll', setActiveToc);
        setActiveToc();
      }

      function makeH2Collapsible(container) {
        const allH2s = Array.from(container.querySelectorAll('h2')).filter(function(h) {
          return !h.closest('.collapsible-section');
        });
        for (let i = allH2s.length - 1; i >= 0; i--) {
          const h2 = allH2s[i];
          const parent = h2.parentNode;
          if (!parent) continue;
          const section = document.createElement('div');
          section.className = 'collapsible-section h2-section collapsed';
          const trigger = document.createElement('div');
          trigger.className = 'collapsible-trigger';
          trigger.setAttribute('role', 'button');
          trigger.setAttribute('tabindex', '0');
          trigger.setAttribute('aria-expanded', 'false');
          trigger.setAttribute('title', '点击展开/收起');
          const icon = document.createElement('span');
          icon.className = 'collapsible-icon';
          icon.setAttribute('aria-hidden', 'true');
          icon.textContent = '\u25BC';
          trigger.appendChild(icon);
          const body = document.createElement('div');
          body.className = 'collapsible-body';
          section.appendChild(trigger);
          section.appendChild(body);
          // Insert section before h2, then move h2 into trigger
          parent.insertBefore(section, h2);
          trigger.appendChild(h2);
          let next = section.nextElementSibling;
          let tag;
          while (next && !next.classList.contains('collapsible-section') && (tag = next.tagName.toUpperCase()) !== 'H1' && tag !== 'H2') {
            body.appendChild(next);
            next = section.nextElementSibling;
          }
          function toggleSection(e) {
            section.classList.toggle('collapsed');
            trigger.setAttribute('aria-expanded', section.classList.contains('collapsed') ? 'false' : 'true');
          }
          trigger.addEventListener('click', toggleSection);
          trigger.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSection(e); }
          });
        }
      }

      function makeH3Collapsible(container) {
        const allH3s = Array.from(container.querySelectorAll('h3')).filter(function(h) {
          return !h.closest('.collapsible-section');
        });
        for (let i = allH3s.length - 1; i >= 0; i--) {
          const h3 = allH3s[i];
          const parent = h3.parentNode;
          if (!parent) continue;
          const section = document.createElement('div');
          section.className = 'collapsible-section collapsed';
          const trigger = document.createElement('div');
          trigger.className = 'collapsible-trigger';
          trigger.setAttribute('role', 'button');
          trigger.setAttribute('tabindex', '0');
          trigger.setAttribute('aria-expanded', 'false');
          trigger.setAttribute('title', '点击展开/收起');
          const icon = document.createElement('span');
          icon.className = 'collapsible-icon';
          icon.setAttribute('aria-hidden', 'true');
          icon.textContent = '\u25BC';
          trigger.appendChild(icon);
          const body = document.createElement('div');
          body.className = 'collapsible-body';
          section.appendChild(trigger);
          section.appendChild(body);
          // Insert section before h3, then move h3 into trigger
          parent.insertBefore(section, h3);
          trigger.appendChild(h3);
          let next = section.nextElementSibling;
          let tag;
          while (next && !next.classList.contains('collapsible-section') && (tag = next.tagName.toUpperCase()) !== 'H1' && tag !== 'H2' && tag !== 'H3') {
            body.appendChild(next);
            next = section.nextElementSibling;
          }
          function toggleSection(e) {
            section.classList.toggle('collapsed');
            trigger.setAttribute('aria-expanded', section.classList.contains('collapsed') ? 'false' : 'true');
          }
          trigger.addEventListener('click', toggleSection);
          trigger.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSection(e); }
          });
        }
      }

      function updateLanguageUI() {
        document.title = pageTitles[currentLang];
        tocTitleEl.textContent = tocTitles[currentLang];
        document.querySelectorAll('.lang-btn').forEach(function(btn) {
          if (btn.dataset.lang === currentLang) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      function switchLanguage(lang) {
        currentLang = lang;
        mdFilename = mdFiles[lang];
        localStorage.setItem('polarDivingLang', lang);
        updateLanguageUI();
        loadContent();
      }

      function tryLoad() {
        var hint = document.createElement('div');
        hint.className = 'load-hint';
        hint.innerHTML = '请用本地服务器打开：在<strong>本文件夹</strong>打开终端，执行 <code>npx serve .</code> 或 <code>python3 -m http.server 8000</code>，然后访问显示的地址（如 http://localhost:3000）。不要直接双击打开 index.html。';
        showError('未能加载文章文件（Failed to fetch）。' + hint.outerHTML);
      }

      function loadContent() {
        contentEl.style.display = 'none';
        loadingEl.style.display = 'block';
        errorEl.style.display = 'none';

        var encodedFilename = encodeURIComponent(mdFilename);
        fetch(encodedFilename)
          .then(function(r) {
            if (!r.ok) throw new Error(r.status + ' ' + mdFilename);
            return r.text();
          })
          .then(render)
          .catch(function(err) {
            fetch('./' + encodedFilename)
              .then(function(r) {
                if (!r.ok) throw new Error(r.status);
                return r.text();
              })
              .then(render)
              .catch(tryLoad);
          });
      }

      // Initialize
      updateLanguageUI();
      loadContent();

      // Add language switcher event listeners
      document.querySelectorAll('.lang-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          switchLanguage(btn.dataset.lang);
        });
      });
    })();
  </script>
</body>
</html>
